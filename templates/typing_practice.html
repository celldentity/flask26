{% extends 'layout.html' %}

{% block content %}
<style>
    /* í°íŠ¸ ë° ê¸°ë³¸ ë°°ê²½ */
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500&display=swap');

    .typing-container {
        max-width: 900px;
        margin: 20px auto;
    }

    /* íƒ€ì´í•‘ ì¹´ë“œ ë””ìì¸ */
    .typing-card {
        background: #ffffff;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border: none;
        overflow: hidden;
    }

    .typing-header {
        background: #f8f9fa;
        padding: 20px 30px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* ìŠ¤íƒ¯ ë ˆì´ì•„ì›ƒ */
    .stat-box {
        display: flex;
        gap: 20px;
    }
    .stat-item {
        text-align: center;
    }
    .stat-value {
        font-size: 1.2rem;
        font-weight: bold;
        color: #198754; /* ë¶€íŠ¸ìŠ¤íŠ¸ë© success ì»¬ëŸ¬ */
    }
    .stat-label {
        font-size: 0.75rem;
        color: #6c757d;
        display: block;
    }

    /* ë³¸ë¬¸ ì˜ì—­ */
    .typing-body {
        padding: 40px;
        position: relative;
        min-height: 300px;
    }

    .quote-info {
        font-style: italic;
        color: #6c757d;
        margin-bottom: 20px;
        border-left: 4px solid #198754;
        padding-left: 15px;
    }

    #target-sentence {
        font-family: 'Roboto Mono', 'Noto Sans KR', monospace;
        font-size: 1.5rem;
        line-height: 2;
        letter-spacing: 0.05rem;
        color: #adb5bd; /* ì•„ì§ ì•ˆ ì¹œ ê¸€ì ìƒ‰ */
        white-space: pre-wrap;
        word-break: break-all;
    }

    /* ê¸€ì ìƒíƒœë³„ ìƒ‰ìƒ */
    .char-correct {
        color: #212529 !important; /* ì¹œ ê¸€ìëŠ” ì§„í•˜ê²Œ */
    }
    .char-incorrect {
        color: #dc3545 !important; /* í‹€ë¦° ê¸€ìëŠ” ë¹¨ê°„ìƒ‰ */
        background-color: rgba(220, 53, 69, 0.1);
        text-decoration: underline;
    }
    .active-char {
        background-color: #e8f5e9;
        border-bottom: 3px solid #198754;
        color: #198754;
    }

    /* ì…ë ¥ì°½ (ìˆ¨ê¹€ ì²˜ë¦¬) */
    #typing-input {
        position: absolute;
        opacity: 0;
        z-index: -1;
    }

    /* ì§„í–‰ë°” */
    .progress {
        height: 5px;
        border-radius: 0;
        background-color: #e9ecef;
    }
    .progress-bar {
        background-color: #198754;
        transition: width 0.2s;
    }
</style>

<div class="typing-container">
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <div class="btn-group">
            <a href="/typing?lang=ko" class="btn btn-sm {{ 'btn-success' if typing.lang == 'ko' else 'btn-outline-success' }}">í•œê¸€ ì—°ìŠµ</a>
            <a href="/typing?lang=en" class="btn btn-sm {{ 'btn-success' if typing.lang == 'en' else 'btn-outline-success' }}">English</a>
        </div>
        <span class="text-muted small"><i class="bi bi-keyboard"></i> í™”ë©´ ì•„ë¬´ê³³ì´ë‚˜ í´ë¦­ í›„ íƒ€ì´í•‘í•˜ì„¸ìš”</span>
    </div>

    <div class="card typing-card">
        <div class="progress">
            <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
        </div>

        <div class="typing-header">
            <div class="stat-box">
                <div class="stat-item">
                    <span class="stat-label">í˜„ì¬ íƒ€ìˆ˜</span>
                    <span id="live-cpm" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ì •í™•ë„</span>
                    <span class="stat-value"><span id="live-accuracy">100</span>%</span>
                </div>
            </div>
            <div class="stat-item text-end">
                <span class="stat-label">ì‘ê°€</span>
                <span class="fw-bold">{{ typing.title }}</span>
            </div>
        </div>

        <div class="typing-body" onclick="document.getElementById('typing-input').focus()">
            <div class="quote-info">
                "ì½”ë”© ëª…ì–¸ íƒ€ìì—°ìŠµ - ë¬¸ì¥ì„ ëê¹Œì§€ ì…ë ¥í•˜ì„¸ìš”."
            </div>

            <div id="target-sentence">
                {% if typing %}
                    {%- for char in typing.content -%}
                        <span data-orig="{{ char }}">{{ char }}</span>
                    {%- endfor -%}
                {% else %}
                    ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                {% endif %}
            </div>

            <input type="text" id="typing-input" autofocus autocomplete="off">
        </div>
    </div>
</div>

<div class="modal fade" id="resultModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">ğŸ‰ ì—°ìŠµ ì™„ë£Œ!</h5>
            </div>
            <div class="modal-body p-4 text-center">
                <div class="row g-3">
                    <div class="col-6">
                        <div class="p-3 border rounded bg-light">
                            <small class="text-muted d-block">ì •í™•ë„</small>
                            <span id="accuracy" class="h4 fw-bold text-success">0</span>%
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 border rounded bg-light">
                            <small class="text-muted d-block">í‰ê·  íƒ€ìˆ˜</small>
                            <span id="speed" class="h4 fw-bold text-success">0</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="/" class="btn btn-light">ê·¸ë§Œí•˜ê¸°</a>
                <button onclick="location.reload()" class="btn btn-success">í•œ ë²ˆ ë”!</button>
            </div>
        </div>
    </div>
</div>

<script>
    const inputField = document.getElementById('typing-input');
    const targetSentence = document.getElementById('target-sentence');
    const spans = document.querySelectorAll('#target-sentence span');
    const targetText = "{{ typing.content|safe if typing else '' }}";
    const targetLength = targetText.length;

    let startTime = null;
    let isFinished = false;
    let isComposing = false;

    // ì´ˆê¸° í¬ì»¤ìŠ¤
    window.addEventListener('load', () => {
        if (spans.length > 0) spans[0].classList.add('active-char');
        inputField.focus();
    });

    inputField.addEventListener('compositionstart', () => { isComposing = true; });
    inputField.addEventListener('compositionend', () => { isComposing = false; updateUI(); });
    inputField.addEventListener('input', () => {
        if (!startTime) startTime = new Date();
        updateUI();
    });

    function updateUI() {
        if (isFinished) return;
        const userValue = inputField.value;
        const userLength = userValue.length;

        // ì§„í–‰ë°” ì—…ë°ì´íŠ¸
        document.getElementById('progress-bar').style.width = (userLength / targetLength * 100) + '%';

        spans.forEach((span, i) => {
            const orig = span.getAttribute('data-orig');
            span.className = ''; // í´ë˜ìŠ¤ ì´ˆê¸°í™”

            if (i < userLength) {
                if (userValue[i] === orig) {
                    span.classList.add('char-correct');
                } else {
                    span.classList.add('char-incorrect');
                }
            } else if (i === userLength) {
                span.classList.add('active-char');
            }
        });

        // ì‹¤ì‹œê°„ íƒ€ìˆ˜ ê³„ì‚°
        if (userLength > 0) {
            const elapsed = (new Date() - startTime) / 60000;
            document.getElementById('live-cpm').innerText = Math.round(userLength / elapsed);
        }

        if (!isComposing && userLength >= targetLength) {
            finish();
        }
    }

    function finish() {
        isFinished = true;
        const totalTime = (new Date() - startTime) / 1000;
        const cpm = Math.round(targetLength / (totalTime / 60));
        const correct = document.querySelectorAll('.char-correct').length;
        const accuracy = Math.round((correct / targetLength) * 100);

        document.getElementById('accuracy').innerText = accuracy;
        document.getElementById('speed').innerText = cpm;

        // ë¶€íŠ¸ìŠ¤íŠ¸ë© ëª¨ë‹¬ ë„ìš°ê¸°
        new bootstrap.Modal(document.getElementById('resultModal')).show();
    }
</script>
{% endblock %}